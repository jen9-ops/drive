<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–∞–∫—Ç–∏—á–Ω–∞ –ö–∞—Ä—Ç–∞-–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä</title>

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ö–∞—Ä—Ç–∞-–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/mgrs@2.0.0/mgrs.js"></script>
    
    <style>
        :root {
            --bg-color: rgba(255, 255, 255, 0.85);
            --blur-effect: blur(12px);
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --text-color: #2c2c2c;
            --accent-color: #007aff;
            --record-color: #ff3b30;
            --navigation-color: #3478F6;
            --success-color: #34c759;
            --danger-color: #ff3b30;
            --warning-color: #ff9500;
            --transition-speed: 0.3s;
            --main-bg: #eef1f4;
            --icon-shadow: 0 1px 4px rgba(0,0,0,0.5);
            --icon-color-light: #2c2c2c;
            --icon-color-dark: #f5f5f7;
        }

        [data-theme="dark"] {
            --bg-color: rgba(28, 28, 30, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --text-color: #f5f5f7;
            --main-bg: #1c1c1e;
            --icon-shadow: 0 1px 4px rgba(0,0,0,0.7);
        }
        
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background-color: var(--main-bg);
            overflow: hidden; position: fixed;
        }
        
        #map { width: 100%; height: 100%; z-index: 1; }
        .map-routing-mode, .map-navigation-mode { cursor: crosshair !important; }

        .action-button {
            position: absolute; width: 44px; height: 44px;
            background: none; border: none; border-radius: 50%;
            font-size: 24px; cursor: grab;
            color: var(--icon-color-light);
            display: flex; justify-content: center; align-items: center;
            transition: color 0.2s, transform 0.2s;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 1001;
        }
        [data-theme="dark"] .action-button {
            color: var(--icon-color-dark);
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }
        
        .action-button.grabbing { cursor: grabbing; z-index: 1002; }
        .action-button:hover { color: var(--accent-color); transform: scale(1.15); }
        .action-button.active { color: var(--accent-color); }
        .action-button.navigating { color: var(--navigation-color); animation: pulse 1.5s infinite; }
        .action-button.recording { color: var(--record-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2500; display: flex;
            justify-content: center; align-items: center; opacity: 0;
            visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-color); padding: 25px; border-radius: 12px;
            box-shadow: 0 5px 25px var(--shadow-color); width: 90%; max-width: 400px;
            position: relative; -webkit-backdrop-filter: var(--blur-effect);
            backdrop-filter: var(--blur-effect); max-height: 80vh; overflow-y: auto;
        }
        .modal-content h3 {
            margin-top: 0; border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; margin-bottom: 15px; color: var(--text-color);
        }
        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 28px;
            font-weight: bold; background: none; border: none; cursor: pointer;
            color: var(--text-color); opacity: 0.7; transition: opacity 0.2s;
        }
        .modal-close:hover { opacity: 1; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; color: var(--text-color); }
        .form-group input, .form-group button {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-color); border-radius: 6px; font-size: 14px; box-sizing: border-box;
        }
        .modal-submit-button {
            padding: 12px; font-size: 16px; font-weight: 600; border: none;
            background: var(--accent-color); color: white; border-radius: 8px; cursor: pointer;
            margin-top: 15px; transition: background-color 0.2s;
        }

        .notifications { position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 300px; }
        .notification {
            background: var(--bg-color); border-radius: 8px; padding: 12px 16px; margin-bottom: 10px;
            border-left: 4px solid var(--accent-color); animation: fadeIn 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
            -webkit-backdrop-filter: var(--blur-effect); backdrop-filter: var(--blur-effect);
        }
        .notification.success { border-left-color: var(--success-color); }
        .notification.error { border-left-color: var(--danger-color); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #coords-display {
            position: absolute; bottom: 0; left: 0; z-index: 1000; background: transparent;
            padding: 4px 8px; font-size: 12px; color: var(--text-color);
            text-shadow: 0 0 4px var(--main-bg), 0 0 4px var(--main-bg);
        }
        
        .leaflet-control-zoom { background: transparent !important; border: none !important; box-shadow: none !important; }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: transparent !important;
            color: var(--icon-color-light) !important;
            border: none !important; box-shadow: none !important;
            width: 44px !important; height: 44px !important; line-height: 44px !important;
            font-size: 24px !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;
        }
         [data-theme="dark"] .leaflet-control-zoom-in, [data-theme="dark"] .leaflet-control-zoom-out {
            color: var(--icon-color-dark) !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7) !important;
        }
        
        .leaflet-control-layers { border: 1px solid var(--border-color) !important; background: var(--bg-color) !important; -webkit-backdrop-filter: var(--blur-effect); backdrop-filter: var(--blur-effect); box-shadow: 0 2px 10px var(--shadow-color) !important; color: var(--text-color) !important; border-radius: 8px; }
        .leaflet-routing-container {
            background-color: var(--bg-color) !important; color: var(--text-color) !important; border: 1px solid var(--border-color) !important;
            box-shadow: 0 4px 20px var(--shadow-color) !important; -webkit-backdrop-filter: var(--blur-effect); backdrop-filter: var(--blur-effect);
        }
        
        .list-item {
            padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(128,128,128,0.1); border-radius: 5px; margin-bottom: 5px;
        }
        .list-item:hover { background: rgba(128,128,128,0.2); }
        .list-item-actions button { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 16px; }

        #nav-info-panel {
            position: absolute;
            top: 15px;
            left: 50%;
            z-index: 1000;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            -webkit-backdrop-filter: var(--blur-effect);
            backdrop-filter: var(--blur-effect);
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translate(-50%, -10px); 
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #nav-info-panel.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        #nav-info-panel .separator {
            width: 1px;
            height: 16px;
            background-color: var(--border-color);
        }
        #eta-toggle-btn {
            pointer-events: all;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #eta-toggle-btn:hover {
            background-color: var(--border-color);
        }
        #arrival-weather, .eta-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="notifications"></div>
    <div id="coords-display">Lat/Lon: --, --<br>MGRS: --</div>
    <div id="nav-info-panel"></div>

    <div id="action-buttons">
        <button id="theme-btn" class="action-button" title="–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É"><i class="fa-solid fa-moon"></i></button>
        <button id="gps-btn" class="action-button" title="–ó–Ω–∞–π—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ–ø–æ–ª–æ–∂–µ–Ω–Ω—è"><i class="fa-solid fa-location-crosshairs"></i></button>
        <button id="search-btn" class="action-button" title="–ü–æ—à—É–∫"><i class="fa-solid fa-magnifying-glass"></i></button>
        <button id="weather-btn" class="action-button" title="–ü–æ–≥–æ–¥–∞"><i class="fa-solid fa-cloud-sun"></i></button>
        <button id="routes-btn" class="action-button" title="–ú–æ—ó –º–∞—Ä—à—Ä—É—Ç–∏"><i class="fa-solid fa-list-check"></i></button>
        <button id="record-btn" class="action-button" title="–ó–∞–ø–∏—Å –º–∞—Ä—à—Ä—É—Ç—É"><i class="fa-solid fa-route"></i></button>
        <button id="plan-btn" class="action-button" title="–ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç (2 –∫–ª—ñ–∫–∏)"><i class="fa-solid fa-diamond-turn-right"></i></button>
        <button id="navigate-btn" class="action-button" title="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è"><i class="fa-solid fa-location-arrow"></i></button>
        <button id="install-btn" class="action-button" title="–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫" style="display: none;"><i class="fa-solid fa-download"></i></button>
    </div>

    <div id="save-route-modal" class="modal-overlay"> <div class="modal-content"><button class="modal-close">&times;</button><h3>–ó–±–µ—Ä–µ–≥—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</h3><div class="form-group"><label for="route-name-input">–ù–∞–∑–≤–∞:</label><input type="text" id="route-name-input"></div><div class="form-group"><label for="route-color-picker">–ö–æ–ª—ñ—Ä:</label><input type="color" id="route-color-picker" value="#007aff" style="height: 40px; padding: 0;"></div><p><strong>–î–∏—Å—Ç–∞–Ω—Ü—ñ—è:</strong> <span id="route-distance-display">0.00</span> km</p><div style="display: flex; gap: 10px; margin-top: 20px;"><button id="discard-route-btn" class="modal-submit-button" style="background-color: #8e8e93;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button id="save-route-btn" class="modal-submit-button">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div></div></div>
    <div id="search-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close">&times;</button><h3>–ü–æ—à—É–∫</h3><div class="form-group"><input type="text" id="search-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏..."></div><button id="search-submit-btn" class="modal-submit-button">–ó–Ω–∞–π—Ç–∏</button><div id="search-results" style="margin-top: 15px;"></div></div></div>
    <div id="weather-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close">&times;</button><h3>–ü–æ–≥–æ–¥–∞ –≤ —Ü–µ–Ω—Ç—Ä—ñ –∫–∞—Ä—Ç–∏</h3><div id="weather-details" style="display: flex; flex-direction: column; gap: 8px;"></div></div></div>
    <div id="routes-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close">&times;</button><h3>–ú–æ—ó –º–∞—Ä—à—Ä—É—Ç–∏</h3><div id="route-list" style="margin-bottom: 20px;"></div><div style="display: flex; gap: 10px;"><button id="import-routes-btn" class="modal-submit-button" style="background-color: #5856d6;">–Ü–º–ø–æ—Ä—Ç</button><button id="export-routes-btn" class="modal-submit-button" style="background-color: #ff9500;">–ï–∫—Å–ø–æ—Ä—Ç</button></div></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

    <script>
    // –ö–ª–∞—Å—Å—ã MGRSConverter –∏ Coordinator –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    class MGRSConverter { toMGRS(lat, lng, precision = 5) { try { return mgrs.forward([lng, lat], precision); } catch (error) { console.warn("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤ MGRS:", error); return "–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó"; } } parseMGRS(mgrsString) { try { const mgrsPattern = /^\d{1,2}[C-HJ-NP-X]\s*([A-HJ-NP-Z]{2})\s*(\d{2,10})$/i; if (!mgrsPattern.test(mgrsString.replace(/\s/g, ''))) { return null; } const coords = mgrs.inverse(mgrsString); return { lat: coords[1], lng: coords[0] }; } catch (error) { return null; } } }
    class Coordinator { constructor() { this.mgrsConverter = new MGRSConverter(); } toMGRS(lat, lng, precision = 5) { return this.mgrsConverter.toMGRS(lat, lng, precision); } parse(str) { if (!str || typeof str !== 'string') return null; const trimmedStr = str.trim(); const mgrsCoords = this.mgrsConverter.parseMGRS(trimmedStr); if (mgrsCoords) return mgrsCoords; const formats = [ { regex: /^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/, parser: m => ({ lat: parseFloat(m[1]), lng: parseFloat(m[2]) }) }, { regex: /^([NS]?)\s*(-?\d+\.?\d*)\s*[,\s]+\s*([EW]?)\s*(-?\d+\.?\d*)$/i, parser: m => { let lat = parseFloat(m[2]); let lng = parseFloat(m[4]); if (m[1].toUpperCase() === 'S') lat = -lat; if (m[3].toUpperCase() === 'W') lng = -lng; return { lat, lng }; } }, { regex: /^(\d+)¬∞\s*(\d+)'\s*([\d.]+)"\s*([NS])\s*[,\s]+\s*(\d+)¬∞\s*(\d+)'\s*([\d.]+)"\s*([EW])$/i, parser: m => { let lat = parseFloat(m[1]) + parseFloat(m[2])/60 + parseFloat(m[3])/3600; let lng = parseFloat(m[5]) + parseFloat(m[6])/60 + parseFloat(m[7])/3600; if (m[4].toUpperCase() === 'S') lat = -lat; if (m[8].toUpperCase() === 'W') lng = -lng; return { lat, lng }; } } ]; for (const format of formats) { const match = trimmedStr.match(format.regex); if (match) { const result = format.parser(match); if (this.isValid(result.lat, result.lng)) return result; } } return null; } isValid(lat, lng) { return !isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180; } }

    class TacticalNavigator {
        constructor() {
            this.map = null;
            this.elements = {};
            this.layers = {};
            this.state = {
                isRecording: false,
                isNavigating: false,
                isPlanning: false,
                deferredPrompt: null,
                sunriseTime: null,
                sunsetTime: null,
                etaTarget: 'sunrise',
                routeWeather: null,
            };
            this.services = {
                coordinator: new Coordinator(),
                recording: { watchId: null, points: [], tempLayer: null },
                navigation: { watchId: null, control: null, marker: null, oneWayDistance: 0, lastKnownSpeed: 0 },
                planning: { control: null, waypoints: [] },
                routes: JSON.parse(localStorage.getItem('savedRoutes') || '[]')
            };
        }
        
        // --- –í–µ—Å—å –∫–æ–¥ –¥–æ —Ñ—É–Ω–∫—Ü–∏–∏ toggleNavigation –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
        init() { console.log("üöÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¢–∞–∫—Ç–∏—á–Ω–æ—ó –ö–∞—Ä—Ç–∏-–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä–∞..."); this.initMap(); this.initUI(); this.setupEventHandlers(); this._setupPWA(); this.loadTheme(); this.loadSavedRoutes(); this.showNotification('–î–æ–¥–∞—Ç–æ–∫ –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏!', 'success'); }
        initMap() { this.map = L.map('map', { zoomControl: false }).setView([50.41, 30.64], 11); L.control.zoom({ position: 'bottomright' }).addTo(this.map); this.layers.base = { "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }), "–°—É–ø—É—Ç–Ω–∏–∫": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }), }; this.layers.base["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"].addTo(this.map); this.layers.savedRoutes = L.layerGroup().addTo(this.map); this.layers.mortarRange = L.layerGroup().addTo(this.map); this.services.recording.tempLayer = L.layerGroup().addTo(this.map); L.control.layers(this.layers.base, { "–ó–±–µ—Ä–µ–∂–µ–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏": this.layers.savedRoutes, "–ó–æ–Ω–∞ —É—Ä–∞–∂–µ–Ω–Ω—è": this.layers.mortarRange }).addTo(this.map); this.map.on('mousemove', e => this.updateCoordinates(e.latlng)); this.map.on('click', e => this.updateCoordinates(e.latlng)); }
        initUI() { this.elements = { notifications: document.querySelector('.notifications'), coordsDisplay: document.getElementById('coords-display'), navInfoPanel: document.getElementById('nav-info-panel'), modals: { saveRoute: document.getElementById('save-route-modal'), search: document.getElementById('search-modal'), weather: document.getElementById('weather-modal'), routes: document.getElementById('routes-modal'), }, buttons: { install: document.getElementById('install-btn'), theme: document.getElementById('theme-btn'), record: document.getElementById('record-btn'), } }; this._setupDraggableButtons(); }
        setupEventHandlers() { document.getElementById('theme-btn').addEventListener('click', () => this.toggleTheme()); document.getElementById('gps-btn').addEventListener('click', () => this._getGpsLocation()); document.getElementById('search-btn').addEventListener('click', () => this._showModal('search')); document.getElementById('weather-btn').addEventListener('click', () => this.showWeather()); document.getElementById('routes-btn').addEventListener('click', () => this._showModal('routes')); document.getElementById('record-btn').addEventListener('click', () => this.toggleRecording()); document.getElementById('plan-btn').addEventListener('click', () => this.togglePlanning()); document.getElementById('navigate-btn').addEventListener('click', () => this.toggleNavigation()); this.elements.buttons.install.addEventListener('click', () => this._installPWA()); document.querySelectorAll('.modal-overlay').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) this._hideModal(modal.id.replace('-modal', '')); }); modal.querySelector('.modal-close').addEventListener('click', () => this._hideModal(modal.id.replace('-modal', ''))); }); document.getElementById('save-route-btn').addEventListener('click', () => this._saveRecordedRoute()); document.getElementById('discard-route-btn').addEventListener('click', () => this._discardRecordedRoute()); document.getElementById('search-submit-btn').addEventListener('click', () => this.searchLocation()); document.getElementById('import-routes-btn').addEventListener('click', () => this.importRoutes()); document.getElementById('export-routes-btn').addEventListener('click', () => this.exportRoutes()); document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.searchLocation(); }); }
        _showModal(modalName) { this.elements.modals[modalName].classList.add('visible'); }
        _hideModal(modalName) { this.elements.modals[modalName].classList.remove('visible'); }
        showNotification(message, type = 'info') { const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message; this.elements.notifications.appendChild(notification); setTimeout(() => notification.remove(), 3000); }
        updateCoordinates(latlng) { const lat = latlng.lat.toFixed(5); const lng = latlng.lng.toFixed(5); const mgrs = this.services.coordinator.toMGRS(latlng.lat, latlng.lng); this.elements.coordsDisplay.innerHTML = `Lat/Lon: ${lat}, ${lng}<br>MGRS: ${mgrs}`; }
        toggleTheme(forceTheme = null) { const isDark = forceTheme ? forceTheme === 'dark' : !document.body.hasAttribute('data-theme'); document.body.setAttribute('data-theme', isDark ? 'dark' : ''); if(!isDark) document.body.removeAttribute('data-theme'); this.elements.buttons.theme.querySelector('i').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon'; localStorage.setItem('theme', isDark ? 'dark' : 'light'); if (isDark) { if (!this.map.hasLayer(this.layers.base["–°—É–ø—É—Ç–Ω–∏–∫"])) this.map.addLayer(this.layers.base["–°—É–ø—É—Ç–Ω–∏–∫"]); if (this.map.hasLayer(this.layers.base["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"])) this.map.removeLayer(this.layers.base["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"]); } else { if (!this.map.hasLayer(this.layers.base["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"])) this.map.addLayer(this.layers.base["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"]); if (this.map.hasLayer(this.layers.base["–°—É–ø—É—Ç–Ω–∏–∫"])) this.map.removeLayer(this.layers.base["–°—É–ø—É—Ç–Ω–∏–∫"]); } }
        loadTheme() { const savedTheme = localStorage.getItem('theme'); if (savedTheme) { this.toggleTheme(savedTheme); } }
        _setupDraggableButtons() { document.querySelectorAll('.action-button').forEach((btn, index) => { btn.style.top = `${15 + (index * 60)}px`; btn.style.right = '15px'; this._makeDraggable(btn); }); }
        _makeDraggable(element) { let isDragging = false, wasDragged = false, startX, startY, offsetX, offsetY; const onDown = (e) => { isDragging = true; wasDragged = false; element.classList.add('grabbing'); const event = e.touches ? e.touches[0] : e; startX = event.clientX; startY = event.clientY; const rect = element.getBoundingClientRect(); offsetX = event.clientX - rect.left; offsetY = event.clientY - rect.top; window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove); window.addEventListener('mouseup', onUp); window.addEventListener('touchend', onUp); }; const onMove = (e) => { if (!isDragging) return; const event = e.touches ? e.touches[0] : e; if (!wasDragged && (Math.abs(event.clientX - startX) > 5 || Math.abs(event.clientY - startY) > 5)) { wasDragged = true; } element.style.left = `${event.clientX - offsetX}px`; element.style.top = `${event.clientY - offsetY}px`; element.style.right = 'auto'; }; const onUp = () => { isDragging = false; element.classList.remove('grabbing'); window.removeEventListener('mousemove', onMove); window.removeEventListener('touchmove', onMove); window.removeEventListener('mouseup', onUp); window.removeEventListener('touchend', onUp); }; element.addEventListener('click', e => { if (wasDragged) { e.preventDefault(); e.stopPropagation(); } }, true); element.addEventListener('mousedown', onDown); element.addEventListener('touchstart', onDown); }
        _setupPWA() { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.state.deferredPrompt = e; this.elements.buttons.install.style.display = 'flex'; }); window.addEventListener('appinstalled', () => { this.state.deferredPrompt = null; this.showNotification('–î–æ–¥–∞—Ç–æ–∫ —É—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success'); }); }
        async _installPWA() { if (this.state.deferredPrompt) { this.state.deferredPrompt.prompt(); const { outcome } = await this.state.deferredPrompt.userChoice; if (outcome === 'accepted') { this.elements.buttons.install.style.display = 'none'; } this.state.deferredPrompt = null; } }
        _getGpsLocation() { if (!navigator.geolocation) { this.showNotification("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º", "error"); return; } navigator.geolocation.getCurrentPosition( pos => { const latlng = [pos.coords.latitude, pos.coords.longitude]; this.map.flyTo(latlng, 15); L.marker(latlng).addTo(this.map).bindPopup("–í–∞—à–µ –ø–æ—Ç–æ—á–Ω–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è").openPopup(); this.showNotification("–ú—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∑–Ω–∞–π–¥–µ–Ω–æ", "success"); }, error => { let message = "–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç"; switch(error.code) { case error.PERMISSION_DENIED: message = "–î–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ"; break; case error.POSITION_UNAVAILABLE: message = "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"; break; case error.TIMEOUT: message = "–ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤–∏–π—à–æ–≤"; break; } this.showNotification(message, "error"); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 } ); }
        toggleRecording() { this.state.isRecording = !this.state.isRecording; const button = this.elements.buttons.record; button.classList.toggle('recording', this.state.isRecording); button.querySelector('i').className = this.state.isRecording ? 'fa-solid fa-stop' : 'fa-solid fa-route'; if (this.state.isRecording) { this.services.recording.points = []; this.services.recording.tempLayer.clearLayers(); this.services.recording.watchId = navigator.geolocation.watchPosition(pos => { const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude); this.services.recording.points.push(latlng); if (this.services.recording.points.length > 1) { L.polyline(this.services.recording.points, { color: 'var(--record-color)', weight: 4 }).addTo(this.services.recording.tempLayer); } }, null, { enableHighAccuracy: true }); this.showNotification("–ó–∞–ø–∏—Å —Ç—Ä–µ–∫—É —Ä–æ–∑–ø–æ—á–∞—Ç–æ"); } else { if (this.services.recording.watchId) { navigator.geolocation.clearWatch(this.services.recording.watchId); } if (this.services.recording.points.length > 1) { const coords = this.services.recording.points.map(p => [p.lng, p.lat]); const distance = turf.length(turf.lineString(coords), { units: 'kilometers' }); document.getElementById('route-distance-display').textContent = `${distance.toFixed(2)} km`; document.getElementById('route-name-input').value = `–ú–∞—Ä—à—Ä—É—Ç ${new Date().toLocaleString('uk-UA')}`; this._showModal('saveRoute'); } else { this.services.recording.tempLayer.clearLayers(); } this.showNotification("–ó–∞–ø–∏—Å —Ç—Ä–µ–∫—É –∑—É–ø–∏–Ω–µ–Ω–æ"); } }
        _saveRecordedRoute() { const name = document.getElementById('route-name-input').value.trim(); if (!name) { this.showNotification('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–∞—Ä—à—Ä—É—Ç—É', 'warning'); return; } const color = document.getElementById('route-color-picker').value; const distance = parseFloat(document.getElementById('route-distance-display').textContent); const newRoute = { id: Date.now(), name, color, distance, latlngs: this.services.recording.points }; this.services.routes.push(newRoute); localStorage.setItem('savedRoutes', JSON.stringify(this.services.routes)); this.loadSavedRoutes(); this._hideModal('saveRoute'); this.services.recording.tempLayer.clearLayers(); this.showNotification(`–ú–∞—Ä—à—Ä—É—Ç "${name}" –∑–±–µ—Ä–µ–∂–µ–Ω–æ!`, 'success'); }
        _discardRecordedRoute() { this.services.recording.tempLayer.clearLayers(); this.services.recording.points = []; this._hideModal('saveRoute'); this.showNotification("–ú–∞—Ä—à—Ä—É—Ç —Å–∫–∞—Å–æ–≤–∞–Ω–æ", "info"); }
        loadSavedRoutes() { this.layers.savedRoutes.clearLayers(); const routeListContainer = document.getElementById('route-list'); routeListContainer.innerHTML = ''; if (this.services.routes.length === 0) { routeListContainer.innerHTML = '<p>–ó–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –Ω–µ–º–∞—î.</p>'; return; } this.services.routes.forEach(route => { const routeLine = L.polyline(route.latlngs, { color: route.color || '#007aff', weight: 4, opacity: 0.8 }).addTo(this.layers.savedRoutes); routeLine.bindPopup(`<b>${route.name}</b><br>–î–∏—Å—Ç–∞–Ω—Ü—ñ—è: ${route.distance.toFixed(2)} –∫–º<br>–¢–æ—á–æ–∫: ${route.latlngs.length}`); const listItem = document.createElement('div'); listItem.className = 'list-item'; listItem.innerHTML = `<span>${route.name} (${route.distance.toFixed(2)} –∫–º)</span><div class="list-item-actions"><button data-id="${route.id}" title="–í–∏–¥–∞–ª–∏—Ç–∏">&times;</button></div>`; listItem.addEventListener('click', (e) => { if (e.target.tagName !== 'BUTTON') { this.map.fitBounds(routeLine.getBounds()); routeLine.openPopup(); } }); listItem.querySelector('button').addEventListener('click', (e) => { e.stopPropagation(); this.deleteRoute(route.id); }); routeListContainer.appendChild(listItem); }); }
        deleteRoute(id) { if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –º–∞—Ä—à—Ä—É—Ç?")) return; this.services.routes = this.services.routes.filter(r => r.id !== id); localStorage.setItem('savedRoutes', JSON.stringify(this.services.routes)); this.loadSavedRoutes(); this.showNotification("–ú–∞—Ä—à—Ä—É—Ç –≤–∏–¥–∞–ª–µ–Ω–æ", "success"); }
        exportRoutes() { if (this.services.routes.length === 0) { this.showNotification("–ù–µ–º–∞—î –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É", "warning"); return; } const dataStr = JSON.stringify(this.services.routes, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = "routes_" + new Date().toISOString().split('T')[0] + ".json"; link.href = url; link.click(); URL.revokeObjectURL(url); this.showNotification("–ú–∞—Ä—à—Ä—É—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ", "success"); }
        importRoutes() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = event => { try { const importedRoutes = JSON.parse(event.target.result); if (Array.isArray(importedRoutes)) { this.services.routes = [...this.services.routes, ...importedRoutes]; localStorage.setItem('savedRoutes', JSON.stringify(this.services.routes)); this.loadSavedRoutes(); this.showNotification(`–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${importedRoutes.length} –º–∞—Ä—à—Ä—É—Ç—ñ–≤`, "success"); } else { this.showNotification("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É", "error"); } } catch (err) { this.showNotification("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É —Ñ–∞–π–ª—É", "error"); } }; reader.readAsText(file); }; input.click(); }
        async searchLocation() { const query = document.getElementById('search-input').value.trim(); const resultsContainer = document.getElementById('search-results'); if (!query) { this.showNotification("–í–≤–µ–¥—ñ—Ç—å –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç", "warning"); return; } resultsContainer.innerHTML = '–ü–æ—à—É–∫...'; const coords = this.services.coordinator.parse(query); if (coords) { this.map.flyTo([coords.lat, coords.lng], 15); L.marker([coords.lat, coords.lng]).addTo(this.map).bindPopup(`–ó–Ω–∞–π–¥–µ–Ω–æ: ${query}`).openPopup(); this._hideModal('search'); this.showNotification(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω–æ: ${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`, "success"); return; } try { const response = await fetch( `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1` ); const data = await response.json(); resultsContainer.innerHTML = ''; if (data.length === 0) { resultsContainer.innerHTML = '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.'; return; } data.forEach(item => { const resultEl = document.createElement('div'); resultEl.className = 'list-item'; resultEl.innerHTML = `<div><strong>${item.display_name}</strong><div style="font-size: 12px; color: #666;">${item.lat}, ${item.lon}</div></div>`; resultEl.onclick = () => { const latlng = [parseFloat(item.lat), parseFloat(item.lon)]; this.map.flyTo(latlng, 15); L.marker(latlng).addTo(this.map).bindPopup(`<b>${item.display_name}</b>`).openPopup(); this._hideModal('search'); this.showNotification(`–ú—ñ—Å—Ü–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ${item.display_name}`, "success"); }; resultsContainer.appendChild(resultEl); }); } catch (e) { resultsContainer.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É.'; console.error('Search error:', e); } }
        async _fetchSunriseSunset(lat, lng) { try { const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=sunrise,sunset&timezone=auto&forecast_days=1`); if (!response.ok) throw new Error('Network response was not ok'); const data = await response.json(); return { sunrise: new Date(data.daily.sunrise[0]), sunset: new Date(data.daily.sunset[0]), }; } catch (error) { console.error('Sunrise/Sunset fetch error:', error); this.showNotification("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Å —Å—Ö–æ–¥—É —Å–æ–Ω—Ü—è", "error"); return null; } }
        async _fetchRouteWeather(lat, lng) { try { const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,precipitation_probability,weather_code&timezone=auto`); if (!response.ok) throw new Error('Weather fetch failed'); const data = await response.json(); return data; } catch (error) { console.error("Route weather error:", error); this.showNotification("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—É", "error"); return null; } }
        async showWeather() { this._showModal('weather'); const detailsContainer = document.getElementById('weather-details'); detailsContainer.innerHTML = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≥–æ–¥–∏...'; const center = this.map.getCenter(); const sunTimes = await this._fetchSunriseSunset(center.lat, center.lng); try { const response = await fetch( `https://api.open-meteo.com/v1/forecast?latitude=${center.lat}&longitude=${center.lng}&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m&timezone=auto&forecast_days=1` ); if (!response.ok) throw new Error('Network response was not ok'); const data = await response.json(); const weatherCodes = { 0: '–Ø—Å–Ω–æ', 1: '–ü–µ—Ä–µ–≤–∞–∂–Ω–æ —è—Å–Ω–æ', 2: '–ú—ñ–Ω–ª–∏–≤–∞ —Ö–º–∞—Ä–Ω—ñ—Å—Ç—å', 3: '–•–º–∞—Ä–Ω–æ', 45: '–¢—É–º–∞–Ω', 48: '–¢—É–º–∞–Ω –∑ —ñ–Ω–µ—î–º', 51: '–ú—Ä—è–∫–∞: –ª–µ–≥–∫–∞', 53: '–ú—Ä—è–∫–∞: –ø–æ–º—ñ—Ä–Ω–∞', 55: '–ú—Ä—è–∫–∞: –≥—É—Å—Ç–∞', 61: '–î–æ—â: –ª–µ–≥–∫–∏–π', 63: '–î–æ—â: –ø–æ–º—ñ—Ä–Ω–∏–π', 65: '–î–æ—â: —Å–∏–ª—å–Ω–∏–π', 80: '–ó–ª–∏–≤–∞: –ª–µ–≥–∫–∞', 81: '–ó–ª–∏–≤–∞: –ø–æ–º—ñ—Ä–Ω–∞', 82: '–ó–ª–∏–≤–∞: —Å–∏–ª—å–Ω–∞' }; const weatherDescription = weatherCodes[data.current.weather_code] || '–ù–µ–≤—ñ–¥–æ–º–æ'; const weatherHTML = ` <p><strong>–°—Ç–∞–Ω–æ–≤–∏—â–µ:</strong> ${weatherDescription}</p> <p><strong>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</strong> ${data.current.temperature_2m}¬∞C</p> <p><strong>–í–æ–ª–æ–≥—ñ—Å—Ç—å:</strong> ${data.current.relative_humidity_2m}%</p> <p><strong>–í—ñ—Ç–µ—Ä:</strong> ${data.current.wind_speed_10m} –∫–º/–≥–æ–¥</p> <p><strong>–°—Ö—ñ–¥ —Å–æ–Ω—Ü—è:</strong> ${sunTimes ? sunTimes.sunrise.toLocaleTimeString('uk-UA') : '–ù/–î'}</p> <p><strong>–ó–∞—Ö—ñ–¥ —Å–æ–Ω—Ü—è:</strong> ${sunTimes ? sunTimes.sunset.toLocaleTimeString('uk-UA') : '–ù/–î'}</p> <p><em>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</em></p> `; detailsContainer.innerHTML = weatherHTML; } catch (error) { detailsContainer.innerHTML = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≥–æ–¥—É.'; console.error('Weather error:', error); } }
        togglePlanning() { this.state.isPlanning = !this.state.isPlanning; const button = document.getElementById('plan-btn'); button.classList.toggle('active', this.state.isPlanning); this.map.getContainer().classList.toggle('map-routing-mode', this.state.isPlanning); if(this.state.isPlanning) { this.services.planning.waypoints = []; if(this.services.planning.control) { this.map.removeControl(this.services.planning.control); } this.layers.mortarRange.clearLayers(); this.map.on('click', this._handlePlanningClick, this); this.showNotification("–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤—É —Ç–æ—á–∫—É"); } else { this.map.off('click', this._handlePlanningClick, this); this.showNotification("–†–µ–∂–∏–º –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ"); } }
        _handlePlanningClick(e) { this.services.planning.waypoints.push(e.latlng); L.marker(e.latlng, { icon: L.divIcon({ className: 'planning-marker', html: `<div style="background: var(--accent-color); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">${this.services.planning.waypoints.length}</div>`, iconSize: [20, 20] }) }).addTo(this.layers.mortarRange); if (this.services.planning.waypoints.length === 1) { this.showNotification("–¢–µ–ø–µ—Ä –∫–ª—ñ–∫–Ω—ñ—Ç—å, —â–æ–± –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫—ñ–Ω—Ü–µ–≤—É —Ç–æ—á–∫—É"); } if (this.services.planning.waypoints.length === 2) { this.services.planning.control = L.Routing.control({ waypoints: this.services.planning.waypoints, createMarker: () => null, show: false, lineOptions: { styles: [{color: 'var(--accent-color)', opacity: 0.8, weight: 6}], extendToWaypoints: true, missingRouteTolerance: 10 }, routeWhileDragging: true, showAlternatives: false }).addTo(this.map); this.services.planning.control.on('routesfound', e => { const route = e.routes[0]; const coords = route.coordinates.map(c => [c.lng, c.lat]); this._calculateAndDrawMortarRange(coords, 400, 3500); this.showNotification(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ–±—É–¥–æ–≤–∞–Ω–æ. –î–∏—Å—Ç–∞–Ω—Ü—ñ—è: ${(route.summary.totalDistance / 1000).toFixed(2)} –∫–º`); }); this.services.planning.control.on('routingerror', e => { this.showNotification("–ü–æ–º–∏–ª–∫–∞ –ø–æ–±—É–¥–æ–≤–∏ –º–∞—Ä—à—Ä—É—Ç—É", "error"); }); this.togglePlanning(); } }
        _calculateAndDrawMortarRange(coords, min, max) { try { const routeLine = turf.lineString(coords); const maxBuffer = turf.buffer(routeLine, max, { units: 'meters' }); const minBuffer = turf.buffer(routeLine, min, { units: 'meters' }); const effectiveZone = turf.difference(maxBuffer, minBuffer); L.geoJSON(effectiveZone, { style: { color: "#ff4747", weight: 2, opacity: 0.7, fillColor: "#ff4747", fillOpacity: 0.3 } }).addTo(this.layers.mortarRange).bindPopup(`–ó–æ–Ω–∞ —É—Ä–∞–∂–µ–Ω–Ω—è<br>–î–∞–ª—å–Ω—ñ—Å—Ç—å: ${min}-${max} –º`); } catch (e) { console.error("–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–æ–Ω–∏ —É—Ä–∞–∂–µ–Ω–Ω—è:", e); this.showNotification("–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–æ–Ω–∏ —É—Ä–∞–∂–µ–Ω–Ω—è", "error"); } }

        toggleNavigation() {
            this.state.isNavigating = !this.state.isNavigating;
            const button = document.getElementById('navigate-btn');
            button.classList.toggle('navigating', this.state.isNavigating);
             
            if(this.state.isNavigating) {
                this.map.getContainer().classList.add('map-navigation-mode');
                this.showNotification("–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –æ–±—Ä–∞—Ç–∏ –ø—É–Ω–∫—Ç –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è");
                
                this.map.once('click', (e) => {
                    this.map.getContainer().classList.remove('map-navigation-mode');
                    const destination = e.latlng;

                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        const start = L.latLng(pos.coords.latitude, pos.coords.longitude);
                        
                        this.elements.navInfoPanel.innerHTML = `<span>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>`;
                        this.elements.navInfoPanel.classList.add('visible');

                        const sunTimes = await this._fetchSunriseSunset(start.lat, start.lng);
                        this.state.sunriseTime = sunTimes ? sunTimes.sunrise : null;
                        this.state.sunsetTime = sunTimes ? sunTimes.sunset : null;
                        this.state.routeWeather = await this._fetchRouteWeather(destination.lat, destination.lng);

                        this.services.navigation.control = L.Routing.control({ waypoints: [start, destination], routeWhileDragging: true, showAlternatives: false, lineOptions: { styles: [{color: 'var(--navigation-color)', opacity: 0.8, weight: 6}] } }).addTo(this.map);
                        this.services.navigation.control.on('routesfound', e => { this.services.navigation.oneWayDistance = e.routes[0].summary.totalDistance; });
                        this.services.navigation.control.on('routingerror', () => { this.showNotification("–ü–æ–º–∏–ª–∫–∞ –ø–æ–±—É–¥–æ–≤–∏ –º–∞—Ä—à—Ä—É—Ç—É", "error"); this.toggleNavigation(); });
                        this.services.navigation.marker = L.circleMarker(start, { radius: 8, color: 'var(--navigation-color)', fillColor: 'var(--navigation-color)', fillOpacity: 0.8 }).addTo(this.map);
                        this.map.flyTo(start, 16);
                        
                        this.services.navigation.watchId = navigator.geolocation.watchPosition(
                            pos => {
                                const newLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
                                this.services.navigation.marker.setLatLng(newLatLng);
                                this.services.navigation.control.spliceWaypoints(0, 1, newLatLng);
                                this.services.navigation.lastKnownSpeed = pos.coords.speed;
                                this._updateNavPanel(pos.coords.speed); 
                            },
                            () => this.showNotification("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó", "error"),
                            { enableHighAccuracy: true }
                        );
                        
                    }, () => { this.showNotification("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à—É –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é", "error"); this.toggleNavigation(); });
                });
            } else {
                this.map.getContainer().classList.remove('map-navigation-mode');
                this.map.off('click');
                if (this.services.navigation.watchId) navigator.geolocation.clearWatch(this.services.navigation.watchId);
                if (this.services.navigation.control) this.map.removeControl(this.services.navigation.control);
                if (this.services.navigation.marker) this.map.removeLayer(this.services.navigation.marker);
                
                this.elements.navInfoPanel.classList.remove('visible');
                this.services.navigation = { watchId: null, control: null, marker: null, oneWayDistance: 0, lastKnownSpeed: 0 };
                this.state.sunriseTime = null;
                this.state.sunsetTime = null;
                this.state.routeWeather = null;
                this.state.etaTarget = 'sunrise';
                this.showNotification("–ù–∞–≤—ñ–≥–∞—Ü—ñ—é –≤–∏–º–∫–Ω–µ–Ω–æ");
            }
        }
        
        // === –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ ===
        _updateNavPanel(speedInMps) {
            const speed = speedInMps || 0;
            const speedKmh = (speed * 3.6).toFixed(1);
            
            let weatherHtml = '–ü–æ–≥–æ–¥–∞: –ù/–î';
            const oneWayDistance = this.services.navigation.oneWayDistance || 0;
            if (this.state.routeWeather && speed > 0.5) {
                const timeToOneWayArrivalSeconds = oneWayDistance / speed;
                const arrivalDate = new Date(Date.now() + timeToOneWayArrivalSeconds * 1000);
                const arrivalHour = arrivalDate.getHours();
                const arrivalDateString = arrivalDate.toISOString().substring(0, 10);
                const weatherCodes = {0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"üå•Ô∏è",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üåßÔ∏è",53:"üåßÔ∏è",55:"üåßÔ∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",80:"üåßÔ∏è",81:"üåßÔ∏è",82:"üåßÔ∏è"};
                try {
                    const timeIndex = this.state.routeWeather.hourly.time.findIndex(t => t.startsWith(`${arrivalDateString}T${String(arrivalHour).padStart(2, '0')}`));
                    if (timeIndex !== -1) {
                        const code = this.state.routeWeather.hourly.weather_code[timeIndex];
                        const temp = Math.round(this.state.routeWeather.hourly.temperature_2m[timeIndex]);
                        const precip = this.state.routeWeather.hourly.precipitation_probability[timeIndex];
                        weatherHtml = `<div id="arrival-weather" title="–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —á–∞—Å –ø—Ä–∏–±—É—Ç—Ç—è"><span>${weatherCodes[code] || '‚ùì'}</span> ${temp}¬∞C | ${precip}% üíß</div>`;
                    }
                } catch(e) { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É */ }
            }

            const targetTime = this.state.etaTarget === 'sunrise' ? this.state.sunriseTime : this.state.sunsetTime;
            const targetLabel = this.state.etaTarget === 'sunrise' ? '—Å—Ö–æ–¥—É' : '–∑–∞—Ö–æ–¥—É';
            let etaHtml = '';
            let suggestedSpeedHtml = ''; // –î–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏

            if (!targetTime) {
                etaHtml = `üåÖ –ß–∞—Å ${targetLabel} –Ω–µ–≤—ñ–¥–æ–º–∏–π`;
            } else {
                const roundTripDistance = oneWayDistance * 2;
                const timeRemainingSeconds = (targetTime.getTime() - Date.now()) / 1000;

                if (speed < 0.5) {
                    etaHtml = `—Ç—É–¥–∏ –π –Ω–∞–∑–∞–¥: ${(roundTripDistance / 1000).toFixed(2)} –∫–º`;
                } else {
                    const timeToArrivalSeconds = roundTripDistance / speed;
                    const returnDate = new Date(Date.now() + timeToArrivalSeconds * 1000);
                    const timeDiff = targetTime.getTime() - returnDate.getTime();
                    const formatDiff = (ms) => {
                        const totalSeconds = Math.abs(Math.floor(ms / 1000));
                        const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                        const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                        return `${hours}:${minutes}`;
                    };
                    
                    if (timeDiff > 0) {
                        etaHtml = `‚úÖ –í—Å—Ç–∏–≥–Ω–µ—Ç–µ –¥–æ ${targetLabel} (–∑–∞–ø–∞—Å: ${formatDiff(timeDiff)})`;
                    } else {
                        etaHtml = `‚ùå –ó–∞–ø—ñ–∑–Ω–µ–Ω–Ω—è –¥–æ ${targetLabel}: ${formatDiff(timeDiff)}`;
                        // –†–∞—Å—á–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–ø–∞–∑–¥—ã–≤–∞–µ–º –∏ –µ—â–µ –µ—Å—Ç—å –≤—Ä–µ–º—è
                        if (timeRemainingSeconds > 0) {
                            const requiredSpeedMs = roundTripDistance / timeRemainingSeconds;
                            const requiredSpeedKmh = (requiredSpeedMs * 3.6).toFixed(1);
                            suggestedSpeedHtml = `<span class="separator"></span> <span title="–ü–æ—Ç—Ä—ñ–±–Ω–∞ —Å–µ—Ä–µ–¥–Ω—è —à–≤–∏–¥–∫—ñ—Å—Ç—å">üèÉ ${requiredSpeedKmh} –∫–º/–≥–æ–¥</span>`;
                        }
                    }
                }
            }
            
            const toggleIcon = this.state.etaTarget === 'sunrise' ? 'üåá' : 'üåÖ';
            
            this.elements.navInfoPanel.innerHTML = `
                <div class="eta-info">${weatherHtml}</div>
                <div class="separator"></div>
                <div class="eta-info">üöÄ ${speedKmh} –∫–º/–≥–æ–¥</div>
                <div class="separator"></div>
                <div class="eta-info">${etaHtml}${suggestedSpeedHtml}</div>
                <button id="eta-toggle-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ –Ω–∞ –∑–∞—Ö—ñ–¥/—Å—Ö—ñ–¥ —Å–æ–Ω—Ü—è">${toggleIcon}</button>
            `;
            
            document.getElementById('eta-toggle-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                this.state.etaTarget = this.state.etaTarget === 'sunrise' ? 'sunset' : 'sunrise';
                this._updateNavPanel(this.services.navigation.lastKnownSpeed);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const app = new TacticalNavigator();
        app.init();
        window.app = app;
    });
    </script>
</body>
</html>
